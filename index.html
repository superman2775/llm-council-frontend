<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LLM Council</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #0b1120;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      padding: 12px 16px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    header small {
      color: #9ca3af;
    }
    main {
      flex: 1;
      display: flex;
      padding: 12px;
      gap: 12px;
      min-height: 0;
    }
    .left, .right {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .panel {
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 8px;
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 100%;
      min-height: 0;
    }
    .panel h2 {
      font-size: 14px;
      margin: 0 0 4px 0;
      color: #9ca3af;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .input-area {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    textarea {
      width: 100%;
      min-height: 100px;
      resize: vertical;
      background: #020617;
      color: #e5e7eb;
      border-radius: 6px;
      border: 1px solid #1f2937;
      padding: 8px;
      font-size: 14px;
      font-family: inherit;
    }
    textarea:focus {
      outline: 1px solid #4f46e5;
      border-color: #4f46e5;
    }
    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    button {
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .status {
      font-size: 12px;
      color: #9ca3af;
    }
    .output {
      flex: 1;
      background: #020617;
      border-radius: 6px;
      border: 1px solid #1f2937;
      padding: 8px;
      font-size: 14px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .council-tabs {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-bottom: 4px;
    }
    .council-tab {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #374151;
      cursor: pointer;
      background: #020617;
      color: #9ca3af;
    }
    .council-tab.active {
      background: #4f46e5;
      border-color: #4f46e5;
      color: white;
    }
    .model-output {
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.5;
    }
    .final-answer {
      white-space: pre-wrap;
      font-size: 14px;
      line-height: 1.6;
    }
    .meta {
      font-size: 12px;
      color: #9ca3af;
    }
    footer {
      padding: 6px 10px;
      font-size: 11px;
      color: #6b7280;
      border-top: 1px solid #1f2937;
      background: #020617;
      text-align: right;
    }
    @media (max-width: 900px) {
      main {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>LLM Council</h1>
      <small>Ask multiple LLMs at once; council synthesizes a final answer.</small>
    </div>
    <div class="meta" id="backend-info">
      Backend: <span id="backend-url"></span>
    </div>
  </header>

  <main>
    <div class="left">
      <div class="panel">
        <h2>
          Your Question
          <span class="status" id="status">Idle</span>
        </h2>
        <div class="input-area">
          <textarea id="prompt" placeholder="Ask the council anything..."></textarea>
          <div class="controls">
            <button id="ask-btn">
              Ask Council
            </button>
            <button id="stop-btn" disabled>Stop</button>
          </div>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="panel">
        <h2>
          Council Responses
        </h2>
        <div class="council-tabs" id="council-tabs"></div>
        <div class="output" id="council-output">
          Ask a question to see individual model responses here.
        </div>
      </div>

      <div class="panel" style="margin-top:8px;">
        <h2>Final Answer</h2>
        <div class="output" id="final-output">
          The synthesized council answer will appear here.
        </div>
      </div>
    </div>
  </main>

  <footer>
    Backend powered by LLM Council on Render. Frontend is a static site (no server-side code).
  </footer>

  <script>
    // ==== CONFIG ====
    const API_BASE = 'https://llm-council-frxu.onrender.com';
    const API_TOKEN = '9f3b9d4e4b2d4a0ea1f4200c6be0da8c1e8e4d8f4b9c2c1f7c5d9b7a0c3f1d2';          //I dont give a fuck about this leaked key lol

    document.getElementById('backend-url').textContent = API_BASE;

    const promptInput = document.getElementById('prompt');
    const askBtn = document.getElementById('ask-btn');
    const stopBtn = document.getElementById('stop-btn');
    const statusEl = document.getElementById('status');
    const tabsEl = document.getElementById('council-tabs');
    const councilOutputEl = document.getElementById('council-output');
    const finalOutputEl = document.getElementById('final-output');

    let abortController = null;
    let currentCouncilData = null;
    let activeModelId = null;

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function setLoading(isLoading) {
      askBtn.disabled = isLoading;
      stopBtn.disabled = !isLoading;
      promptInput.disabled = isLoading;
      setStatus(isLoading ? 'Running council...' : 'Idle');
    }

    function renderTabs() {
      tabsEl.innerHTML = '';
      if (!currentCouncilData || !currentCouncilData.models) {
        return;
      }
      currentCouncilData.models.forEach(model => {
        const btn = document.createElement('button');
        btn.className = 'council-tab' + (model.id === activeModelId ? ' active' : '');
        btn.textContent = model.display_name || model.name || model.id;
        btn.onclick = () => {
          activeModelId = model.id;
          renderTabs();
          renderModelOutput();
        };
        tabsEl.appendChild(btn);
      });
    }

    function renderModelOutput() {
      if (!currentCouncilData || !currentCouncilData.models) {
        councilOutputEl.textContent = 'No model responses yet.';
        return;
      }
      const model = currentCouncilData.models.find(m => m.id === activeModelId) || currentCouncilData.models[0];
      if (!model) {
        councilOutputEl.textContent = 'No model responses yet.';
        return;
      }
      activeModelId = model.id;
      const responseText = model.response_text || model.response || '(no response text)';
      const rankings = model.rankings || model.review || null;

      councilOutputEl.innerHTML = `
        <div class="model-output">
          <strong>${model.display_name || model.name || model.id}</strong>
          <br /><br />
          ${escapeHtml(responseText)}
        </div>
        ${rankings ? `
          <div class="meta" style="margin-top:8px;">
            Ranked peers: ${escapeHtml(JSON.stringify(rankings, null, 2))}
          </div>
        ` : ''}
      `;
    }

    function renderFinalAnswer() {
      if (!currentCouncilData || !currentCouncilData.final_answer) {
        finalOutputEl.textContent = 'No final answer yet.';
        return;
      }
      finalOutputEl.innerHTML = `
        <div class="final-answer">
          ${escapeHtml(currentCouncilData.final_answer)}
        </div>
      `;
    }

    function escapeHtml(text) {
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    async function callCouncil(prompt) {
      setLoading(true);
      currentCouncilData = null;
      activeModelId = null;
      tabsEl.innerHTML = '';
      councilOutputEl.textContent = 'Waiting for council responses...';
      finalOutputEl.textContent = 'Waiting for final answer...';

      abortController = new AbortController();

      try {
        const response = await fetch(API_BASE + '/v1/council/run', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(API_TOKEN ? { 'Authorization': 'Bearer ' + API_TOKEN } : {})
          },
          body: JSON.stringify({
            prompt: prompt
          }),
          signal: abortController.signal
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error('Backend error: ' + response.status + ' ' + text);
        }

        // The docs show a non-streaming JSON response by default.
        // Adjust if you enable streaming.
        const data = await response.json();
        /*
          Expected shape (approx based on docs):
          {
            "final_answer": "...",
            "models": [
              {
                "id": "openai/gpt-4.1",
                "display_name": "GPT-4.1",
                "response_text": "...",
                "rankings": {...}
              },
              ...
            ]
          }
        */
        currentCouncilData = data;
        if (data.models && data.models.length > 0) {
          activeModelId = data.models[0].id;
        }

        renderTabs();
        renderModelOutput();
        renderFinalAnswer();
        setStatus('Done');
      } catch (err) {
        if (err.name === 'AbortError') {
          setStatus('Cancelled');
        } else {
          console.error(err);
          councilOutputEl.textContent = 'Error: ' + err.message;
          finalOutputEl.textContent = 'Error running council.';
          setStatus('Error');
        }
      } finally {
        setLoading(false);
        abortController = null;
      }
    }

    askBtn.addEventListener('click', () => {
      const prompt = promptInput.value.trim();
      if (!prompt) {
        alert('Type a question first.');
        return;
      }
      callCouncil(prompt);
    });

    stopBtn.addEventListener('click', () => {
      if (abortController) {
        abortController.abort();
      }
    });

    promptInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        askBtn.click();
      }
    });
  </script>
</body>
</html>
